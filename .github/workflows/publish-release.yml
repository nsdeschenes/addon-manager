name: Publish Release

on:
    pull_request:
        types: [closed]

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    publish:
        name: Publish Release
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
        steps:
            - name: Check release label
              id: check_labels
              env:
                  PR_LABELS: ${{ toJSON(github.event.pull_request.labels) }}
              run: |
                  HAS_RELEASE=$(echo "$PR_LABELS" | jq -e 'any(.name == "release")' >/dev/null 2>&1 && echo 'true' || echo 'false')
                  echo "has_release=${HAS_RELEASE}" >> "$GITHUB_OUTPUT"

            - name: Checkout code
              if: steps.check_labels.outputs.has_release == 'true'
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Bun
              if: steps.check_labels.outputs.has_release == 'true'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache dependencies
              if: steps.check_labels.outputs.has_release == 'true'
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun/install/cache
                      node_modules
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              if: steps.check_labels.outputs.has_release == 'true'
              run: bun install --frozen-lockfile

            - name: Build all platforms
              if: steps.check_labels.outputs.has_release == 'true'
              run: bun run build:all

            - name: Upload build artifacts
              if: steps.check_labels.outputs.has_release == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ github.sha }}
                  path: dist/

            - name: Download Craft binary
              if: steps.check_labels.outputs.has_release == 'true'
              shell: bash
              run: |
                  CRAFT_URL=$(curl -fsSL "https://api.github.com/repos/getsentry/craft/releases/latest" \
                    | jq -r '.assets[] | select(.name == "craft") | .browser_download_url')

                  if [[ -z "$CRAFT_URL" ]]; then
                    echo "::error::Failed to determine Craft download URL"
                    exit 1
                  fi

                  echo "Downloading Craft from: ${CRAFT_URL}"
                  sudo curl -fsSL -o /usr/local/bin/craft "$CRAFT_URL"
                  sudo chmod +x /usr/local/bin/craft

                  if [[ ! -s /usr/local/bin/craft ]]; then
                    echo "::error::Downloaded Craft binary is empty or missing"
                    exit 1
                  fi

            - name: Extract version from branch
              if: steps.check_labels.outputs.has_release == 'true'
              id: version
              shell: bash
              run: |
                  HEAD_REF="${{ github.event.pull_request.head.ref }}"
                  if [[ "$HEAD_REF" == release/* ]]; then
                    VERSION="${HEAD_REF#release/}"
                  else
                    VERSION=$(jq -r '.version' package.json)
                  fi
                  echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
                  echo "Extracted version: ${VERSION}"

            - name: Publish release
              if: steps.check_labels.outputs.has_release == 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  craft publish ${{ steps.version.outputs.version }}
